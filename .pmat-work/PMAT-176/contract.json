{
  "work_item_id": "PMAT-176",
  "github_issue": 172,
  "title": "[P0] Format Conversion Testing: Lossy Conversions and NaN Corruption",
  "created_at": "2026-01-30T00:00:00Z",
  "status": "in_progress",
  "severity": "P0",
  "root_cause": "Q4_K_M → F32 → Q4_K_M dequantization/requantization precision loss introduces NaN/Inf values",
  "five_whys": [
    "WHY did round-trip fail? → NaN values appeared in converted tensors",
    "WHY NaN values? → Dequantization → requantization precision loss accumulates",
    "WHY precision loss? → Q4_K_M → F32 → Q4_K_M conversion is not bit-exact",
    "WHY different outputs? → Inference on corrupted weights produces different results",
    "ROOT CAUSE: Any NaN in weights corrupts ALL inference - silent data corruption"
  ],
  "toyota_way_principle": "Stop the Line - NaN/Inf in model weights is catastrophic corruption",
  "evidence": {
    "failures": [
      {"conversion": "GGUF → APR", "status": "FALSIFIED", "diff": "6.77e-1"},
      {"conversion": "APR → GGUF", "status": "FALSIFIED", "diff": "4.16e-1"},
      {"conversion": "GGUF → SafeTensors", "status": "FALSIFIED", "note": "Missing tokenizer.json/config.json"},
      {"conversion": "SafeTensors → GGUF", "status": "FALSIFIED", "diff": "4.16e-1"},
      {"conversion": "SafeTensors → APR", "status": "FALSIFIED", "diff": "6.77e-1"},
      {"conversion": "Round-trip (GGUF→APR→ST→GGUF)", "status": "FALSIFIED", "note": "NaN/Inf values in tensors"}
    ],
    "nan_corruption": {
      "total_errors": 75,
      "examples": [
        "blk.0.attn_k.weight: 322 NaN values",
        "blk.0.attn_output.weight: 1880 NaN values",
        "blk.0.attn_q.weight: 2194 NaN values",
        "blk.0.ffn_down.weight: 7219 NaN values",
        "blk.0.ffn_gate.weight: 12864 NaN values",
        "blk.1.ffn_down.weight: 1 Inf value"
      ]
    }
  },
  "fix": {
    "required": [
      "Add bit-exact round-trip tests to apr rosetta CI",
      "Implement apr rosetta verify --strict with epsilon tolerance checking",
      "Add NaN/Inf detection as hard failure in conversion pipeline",
      "Consider storing original quantization parameters for lossless round-trip"
    ]
  },
  "verification": [
    "apr rosetta convert model.gguf model.apr passes without NaN",
    "apr rosetta convert model.apr model2.gguf produces identical tensor stats",
    "Round-trip conversion NEVER introduces NaN or Inf values",
    "diff tolerance < 1e-6 for all format conversions"
  ]
}
