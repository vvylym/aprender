{
  "work_item_id": "PMAT-186",
  "github_issue": 160,
  "title": "GH-160: Enable Tool Calling support in apr serve API",
  "created_at": "2026-01-30T00:00:00Z",
  "status": "completed",
  "completed_at": "2026-01-30T00:00:00Z",
  "severity": "P2",
  "approach": "Add OpenAI-compatible tool calling to /v1/chat/completions endpoint",
  "five_whys": [
    "WHY need tool calling? → Users want LLMs to interact with external tools/APIs",
    "WHY OpenAI-compatible? → Industry standard, enables drop-in replacement",
    "WHY in apr serve? → Provides production-ready API for tool-enabled agents",
    "WHY now? → Completes OpenAI API compatibility for enterprise adoption",
    "ROOT CAUSE: Missing tool calling fields in request/response handling"
  ],
  "toyota_way_principle": "Jidoka - Build quality in with strongly-typed structures",
  "implementation": {
    "phases": [
      "Phase 1: Add Tool/ToolCall/ChatMessage types with serde",
      "Phase 2: Update request parsing to accept tools array",
      "Phase 3: Format prompt with tool definitions for model",
      "Phase 4: Parse model output to detect tool calls",
      "Phase 5: Return structured ToolCall in response"
    ],
    "files_to_modify": [
      "crates/apr-cli/src/commands/serve.rs"
    ],
    "openai_fields": {
      "request": ["tools", "tool_choice"],
      "message": ["tool_calls", "tool_call_id"],
      "response": ["tool_calls", "finish_reason=tool_calls"]
    }
  },
  "falsification_gates": [
    "F-TOOL-001: tools array accepted in request",
    "F-TOOL-002: tool_choice controls tool usage",
    "F-TOOL-003: tool_calls returned when model invokes tool",
    "F-TOOL-004: Multi-turn tool conversation works",
    "F-TOOL-005: Streaming with tool calls works"
  ],
  "deliverables": {
    "code": ["crates/apr-cli/src/commands/serve.rs"],
    "tests": ["9 unit tests (F-TOOL-001 to F-TOOL-005)"],
    "examples": ["crates/apr-cli/examples/tool_calling_demo.rs"],
    "documentation": ["book/src/tools/apr-cli.md (Tool Calling section)"]
  }
}
