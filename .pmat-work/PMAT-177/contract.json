{
  "work_item_id": "PMAT-177",
  "github_issue": 172,
  "title": "Fix format conversion NaN corruption - Add validation + scale clamping",
  "created_at": "2026-01-30T00:00:00Z",
  "completed_at": "2026-01-30T00:00:00Z",
  "status": "completed",
  "severity": "P0",
  "root_cause": "f16 scale factor precision loss in Q4_K/Q6_K dequant→requant cycles causes underflow to NaN",
  "five_whys": [
    "WHY NaN in round-trip? → dequantize_q4_k_to_f32() outputs NaN values",
    "WHY NaN in dequantize? → Scale factors d/dmin become invalid after f16 encoding",
    "WHY invalid scales? → f16 has min normal ~6.1e-5, scales below that underflow",
    "WHY underflow? → quantize_q4_k() uses 1e-10 fallback which can't be encoded in f16",
    "ROOT CAUSE: No validation of scale factors after f16 round-trip, no NaN detection in conversion pipeline"
  ],
  "toyota_way_principle": "Built-in Quality (Jidoka) - Detect defects at the source, not downstream",
  "fix": {
    "completed": [
      "dequantize_q4_k_to_f32(): Check d/dmin for NaN/Inf/subnormal, replace with 0.0",
      "dequantize_q6_k_to_f32(): Same validation for Q6_K format",
      "quantize_q4_k(): Clamp scales to F16_MIN_NORMAL (6.1e-5) instead of 1e-10"
    ],
    "tests_added": [
      "test_dequantize_q4k_nan_inf_protection_pmat177",
      "test_dequantize_q4k_subnormal_protection_pmat177"
    ]
  },
  "verification": {
    "tests_passed": true,
    "test_count": 7971,
    "tdg_score": "97.5/100 (A+)",
    "note": "Needs re-run of apr-model-qa-playbook to confirm round-trip NaN fix"
  }
}
