{
  "work_item_id": "PMAT-172",
  "github_issue": null,
  "title": "P0: APR Silent Failure Recovery - Remove tokenizer fallback, fail fast",
  "created_at": "2026-01-30T00:00:00Z",
  "status": "implemented",
  "severity": "P0",
  "root_cause": "APR encode_text() silently falls back to HuggingFace cache when embedded tokenizer is missing. This uses WRONG tokenizer from DIFFERENT model, producing garbage output. User sees garbage and thinks MODEL is broken.",
  "five_whys": [
    "WHY garbage output? → Wrong tokens generated",
    "WHY wrong tokens? → Using wrong tokenizer",
    "WHY wrong tokenizer? → Fallback to HF cache found different model's tokenizer",
    "WHY fallback? → encode_text() has 3-tier fallback instead of fail-fast",
    "ROOT CAUSE: Silent Failure Recovery anti-pattern - should FAIL FAST with clear error"
  ],
  "design_violation": "APR format is designed to be ONE self-contained file. Fallback to external files contradicts this design goal.",
  "fix": {
    "principle": "Fail fast with actionable error message",
    "changes": [
      "1. APR encode MUST use embedded tokenizer only - no fallback",
      "2. SafeTensors MUST use sibling tokenizer.json - no HF cache fallback",
      "3. Clear error messages tell user exactly how to fix"
    ]
  },
  "verification": [
    "APR without embedded tokenizer → clear error (not garbage)",
    "APR with embedded tokenizer → correct tokens",
    "No fallback to HuggingFace cache",
    "SafeTensors without sibling tokenizer.json → clear error"
  ],
  "implementation": {
    "completed_at": "2026-01-30",
    "files_modified": [
      "realizar/src/apr/mod.rs - Rewrote encode_text() with fail-fast design",
      "realizar/src/apr/mod.rs - Removed find_tokenizer_json_in_cache() (source of SFR bug)"
    ],
    "error_messages": {
      "apr_missing_tokenizer": "APR file missing embedded tokenizer. Re-convert with: apr convert <source>.gguf -o model.apr",
      "safetensors_missing_tokenizer": "No tokenizer found. Expected sibling file: tokenizer.json"
    }
  }
}
