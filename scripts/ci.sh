#!/bin/bash
# CI/CD script for Aprender
# Generated by bashrs - DO NOT EDIT MANUALLY
# Source: scripts/ci.rs

set -euo pipefail

echo "üöÄ Aprender CI/CD Pipeline"
echo "=========================="
echo ""

# Configuration
COVERAGE_THRESHOLD=85

# Step 1: Format check
echo "üìù [1/7] Format check..."
if ! cargo fmt --check; then
    echo "‚ùå Format check failed"
    exit 1
fi
echo "‚úÖ Format check passed"

# Step 2: Clippy
echo "üîç [2/7] Clippy analysis..."
if ! cargo clippy --all-targets -- -D warnings; then
    echo "‚ùå Clippy check failed"
    exit 1
fi
echo "‚úÖ Clippy check passed"

# Step 3: Unit tests
echo "üß™ [3/7] Unit tests..."
if ! cargo test --lib; then
    echo "‚ùå Unit tests failed"
    exit 1
fi
echo "‚úÖ Unit tests passed"

# Step 4: Property tests
echo "üé≤ [4/7] Property tests (256 cases)..."
if ! PROPTEST_CASES=256 cargo test --test property_tests; then
    echo "‚ùå Property tests failed"
    exit 1
fi
echo "‚úÖ Property tests passed"

# Step 5: Doc tests
echo "üìö [5/7] Documentation tests..."
if ! cargo test --doc; then
    echo "‚ùå Doc tests failed"
    exit 1
fi
echo "‚úÖ Doc tests passed"

# Step 6: Coverage (optional, requires cargo-llvm-cov)
echo "üìä [6/7] Coverage analysis..."
if command -v cargo-llvm-cov &> /dev/null; then
    # Temporarily disable mold linker (breaks LLVM coverage)
    if [ -f ~/.cargo/config.toml ]; then
        mv ~/.cargo/config.toml ~/.cargo/config.toml.ci-backup
    fi

    cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info
    COVERAGE=$(cargo llvm-cov report --summary-only 2>&1 | grep "TOTAL" | awk '{print $10}' | tr -d '%')

    # Restore mold linker
    if [ -f ~/.cargo/config.toml.ci-backup ]; then
        mv ~/.cargo/config.toml.ci-backup ~/.cargo/config.toml
    fi

    echo "Coverage: ${COVERAGE}%"
    if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
        echo "‚ö†Ô∏è  Coverage ${COVERAGE}% below threshold ${COVERAGE_THRESHOLD}%"
    else
        echo "‚úÖ Coverage check passed"
    fi
else
    echo "‚ö†Ô∏è  cargo-llvm-cov not installed, skipping coverage"
fi

# Step 7: TDG Score (optional, requires pmat)
echo "üìà [7/7] TDG Score analysis..."
if command -v pmat &> /dev/null; then
    TDG_OUTPUT=$(pmat tdg 2>&1)
    echo "$TDG_OUTPUT"
    echo "‚úÖ TDG analysis complete"
else
    echo "‚ö†Ô∏è  pmat not installed, skipping TDG analysis"
fi

echo ""
echo "üéâ CI/CD Pipeline Complete!"
echo ""

exit 0
