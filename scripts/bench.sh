#!/bin/bash
# Benchmark script for Aprender
# Generated by bashrs - DO NOT EDIT MANUALLY
# Source: scripts/bench.rs

set -euo pipefail

echo "ğŸ“Š Aprender Benchmark Suite"
echo "==========================="
echo ""

# Configuration
BASELINE_DIR=".performance-baselines"

# Parse arguments
SAVE_BASELINE=false
COMPARE_BASELINE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --save)
            SAVE_BASELINE=true
            shift
            ;;
        --compare)
            COMPARE_BASELINE=true
            shift
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: $0 [--save] [--compare]"
            exit 1
            ;;
    esac
done

# Ensure release build
echo "ğŸ”¨ Building release..."
cargo build --release --quiet

# Run benchmarks
echo "ğŸƒ Running benchmarks..."
echo ""

if [ "$SAVE_BASELINE" = true ]; then
    mkdir -p "$BASELINE_DIR"
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BASELINE_FILE="$BASELINE_DIR/bench_$TIMESTAMP.txt"

    cargo bench --quiet 2>&1 | tee "$BASELINE_FILE"

    echo ""
    echo "âœ… Baseline saved to: $BASELINE_FILE"
elif [ "$COMPARE_BASELINE" = true ]; then
    # Find latest baseline
    LATEST_BASELINE=$(ls -t "$BASELINE_DIR"/bench_*.txt 2>/dev/null | head -1)

    if [ -z "$LATEST_BASELINE" ]; then
        echo "âŒ No baseline found. Run with --save first."
        exit 1
    fi

    echo "ğŸ“ˆ Comparing against: $LATEST_BASELINE"
    echo ""

    # Run benchmarks with comparison
    cargo bench --quiet

    echo ""
    echo "âœ… Benchmark comparison complete"
else
    cargo bench --quiet
fi

echo ""
echo "ğŸ‰ Benchmarks complete!"

exit 0
